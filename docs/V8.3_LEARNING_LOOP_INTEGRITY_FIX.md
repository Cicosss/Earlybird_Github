# V8.3 Learning Loop Integrity Fix

## Overview

This fix addresses a **critical data quality issue** in the bot's learning loop that was causing ROI calculations to be based on incorrect odds data.

## Problem Identified

The audit revealed that both `odds_taken` and `closing_odds` fields in the database were storing **current odds at analysis time**, not historical odds at the actual moments of betting:

1. **`odds_taken`** - Was storing current odds when analysis was run, NOT when alert was sent
2. **`closing_odds`** - Was storing current odds when analysis was run, NOT at match kickoff

### Impact

This caused **fundamentally falsified learning data**:

- ROI calculations used current odds (which may have moved significantly from actual bet odds)
- CLV (Closing Line Value) was meaningless (~0% result) since it compared identical values
- The optimizer adjusted strategy weights based on incorrect ROI data
- Learning loop was reinforcing wrong patterns

### Example Scenario

```
Bet placed at odds 2.10 (actual odds_taken should be 2.10)
Odds drop to 1.80 by analysis time (current odds stored)
Odds drop to 1.70 at kickoff (actual closing odds should be 1.70)

OLD BEHAVIOR:
- odds_taken = 1.80 (wrong - current odds at analysis)
- closing_odds = 1.80 (wrong - current odds at analysis)
- ROI = 1.80 - 1 = 0.80 (actual ROI should be 2.10 - 1 = 1.10)
- CLV = (1.80 / 1.80) - 1 = 0% (meaningless)

NEW BEHAVIOR:
- odds_at_alert = 2.10 (correct - odds when alert was sent)
- odds_at_kickoff = 1.70 (correct - odds at match kickoff)
- ROI = 2.10 - 1 = 1.10 (accurate)
- CLV = (2.10 / 1.70) - 1 = +23.5% (meaningful)
```

## Solution

### 1. Database Schema Changes

Added three new fields to the `NewsLog` table:

| Field | Type | Description |
|--------|--------|-------------|
| `odds_at_alert` | Float | Actual odds when Telegram alert was sent (for ROI calculation) |
| `odds_at_kickoff` | Float | Actual odds at match kickoff (for CLV analysis) |
| `alert_sent_at` | DateTime | Timestamp when alert was sent to Telegram |

**Migration File:** [`src/database/migration_v83_odds_fix.py`](src/database/migration_v83_odds_fix.py)

### 2. Code Changes

#### [`src/main.py`](src/main.py)

Modified to capture odds at alert time (when `send_alert()` is called):

```python
# Before sending alert, capture current odds
odds_at_alert = None
if hasattr(analysis, 'recommended_market') and analysis.recommended_market:
    market_lower = analysis.recommended_market.lower()
    
    if 'home' in market_lower and 'win' in market_lower:
        odds_at_alert = match.current_home_odd
    # ... (other markets)
    
send_alert(...)
analysis.odds_at_alert = odds_at_alert
analysis.alert_sent_at = datetime.now(timezone.utc)
```

#### [`src/services/odds_capture.py`](src/services/odds_capture.py) (NEW)

Created a new scheduled job module to capture odds at match kickoff:

- Finds matches that started within the last 10 minutes
- Refreshes odds from data provider
- Stores them in `NewsLog.odds_at_kickoff`

**Usage:**
```python
from src.services.odds_capture import capture_kickoff_odds
capture_kickoff_odds()  # Run every 5 minutes
```

#### [`src/analysis/settler.py`](src/analysis/settler.py)

Updated ROI and CLV calculations to use new fields:

**ROI Calculation (Priority Order):**
1. `odds_at_alert` (actual odds when alert was sent)
2. `closing_odds` (legacy fallback)
3. Current odds (fallback)
4. Default 1.9 (final fallback)

**CLV Calculation:**
```python
odds_taken = match_data.get('odds_at_alert') or match_data.get('odds_taken')
closing_odds = match_data.get('odds_at_kickoff') or match_data.get('closing_odds')
clv_value = calculate_clv(odds_taken, closing_odds)
```

### 3. Deployment Script

Created [`src/deploy_v83_odds_fix.py`](src/deploy_v83_odds_fix.py) to:

1. Run database migration
2. Verify database schema
3. Test odds capture functionality
4. Verify settler integration
5. Check existing data quality

## Deployment Instructions

### Step 1: Run Migration

```bash
python -m src.database.migration_v83_odds_fix
```

Expected output:
```
âœ… V8.3 Migration completed successfully!
  âœ“ Added odds_at_alert column
  âœ“ Added odds_at_kickoff column
  âœ“ Added alert_sent_at column
```

### Step 2: Run Deployment Script

```bash
python -m src.deploy_v83_odds_fix
```

Expected output:
```
======================================================================
  STEP 1: Running Database Migration V8.3
======================================================================
â„¹ï¸  Starting migration...
âœ… Database migration completed successfully!
...

======================================================================
  DEPLOYMENT SUMMARY
======================================================================
âœ… ALL DEPLOYMENT STEPS COMPLETED SUCCESSFULLY!
```

### Step 3: Add Scheduled Job

Add the kickoff odds capture to your scheduled jobs (e.g., in cron or systemd timer):

**Example cron entry (run every 5 minutes):**
```cron
*/5 * * * * * cd /home/linux/Earlybird_Github && python -m src.services.odds_capture >> logs/odds_capture.log 2>&1
```

**Or integrate into existing scheduler:**
```python
# In your main loop or scheduler
from src.services.odds_capture import capture_kickoff_odds

# Run every 5 minutes
if datetime.now().minute % 5 == 0:
    capture_kickoff_odds()
```

### Step 4: Verify Learning Loop

After running for a few days, check the data quality:

```bash
python -m src.services.odds_capture
```

Expected output:
```
ðŸ“Š Kickoff Odds Capture Stats: {
    'total_sent': 150,
    'with_kickoff_odds': 142,
    'without_kickoff_odds': 8,
    'with_alert_odds': 148,
    'kickoff_capture_rate': 94.7
}
```

Aim for:
- `kickoff_capture_rate` > 90%
- `with_alert_odds` should equal `total_sent` (100%)

## Data Flow After Fix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    V8.3: PROPER ODDS CAPTURE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. ANALYSIS PHASE                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚     â”‚   Analyzer   â”‚â”€â”€â”€â–¶â”‚   NewsLog    â”‚                            â”‚
â”‚     â”‚              â”‚    â”‚              â”‚                            â”‚
â”‚     â”‚ Creates      â”‚    â”‚ odds_taken  â”‚ (legacy, kept for backward     â”‚
â”‚     â”‚ analysis     â”‚    â”‚ = current    â”‚ compatibility)               â”‚
â”‚     â”‚              â”‚    â”‚ odds         â”‚                            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                     â”‚
â”‚  2. ALERT PHASE (NEW!)                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚     â”‚   main.py    â”‚â”€â”€â”€â–¶â”‚   NewsLog    â”‚                            â”‚
â”‚     â”‚              â”‚    â”‚              â”‚                            â”‚
â”‚     â”‚ Captures     â”‚    â”‚ odds_at_    â”‚ (NEW - actual odds when        â”‚
â”‚     â”‚ current      â”‚    â”‚ alert =      â”‚ alert was sent)                â”‚
â”‚     â”‚ odds BEFORE   â”‚    â”‚ 2.10        â”‚                            â”‚
â”‚     â”‚ sending       â”‚    â”‚ alert_sent_  â”‚ (NEW - timestamp)             â”‚
â”‚     â”‚ alert        â”‚    â”‚ at = now     â”‚                            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚           â”‚                                                            â”‚
â”‚           â–¼                                                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚     â”‚  Notifier    â”‚                                                â”‚
â”‚     â”‚  Sends       â”‚                                                â”‚
â”‚     â”‚  Telegram    â”‚                                                â”‚
â”‚     â”‚  alert       â”‚                                                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                                                                     â”‚
â”‚  3. KICKOFF PHASE (NEW!)                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚     â”‚  odds_       â”‚â”€â”€â”€â–¶â”‚   NewsLog    â”‚                            â”‚
â”‚     â”‚  capture.py  â”‚    â”‚              â”‚                            â”‚
â”‚     â”‚  Scheduled   â”‚    â”‚ odds_at_    â”‚ (NEW - actual odds at        â”‚
â”‚     â”‚  job         â”‚    â”‚ kickoff =    â”‚ match kickoff)               â”‚
â”‚     â”‚  runs every  â”‚    â”‚ 1.70        â”‚                            â”‚
â”‚     â”‚  5 minutes   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                                                                     â”‚
â”‚  4. SETTLEMENT PHASE (UPDATED!)                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚     â”‚   Settler    â”‚â”€â”€â”€â–¶â”‚  Optimizer   â”‚                            â”‚
â”‚     â”‚              â”‚    â”‚              â”‚                            â”‚
â”‚     â”‚ Uses         â”‚    â”‚ ROI =        â”‚ (NOW uses odds_at_alert!)    â”‚
â”‚     â”‚ odds_at_     â”‚    â”‚ 2.10 - 1    â”‚                            â”‚
â”‚     â”‚ alert for     â”‚    â”‚ = 1.10       â”‚                            â”‚
â”‚     â”‚ ROI          â”‚    â”‚              â”‚                            â”‚
â”‚     â”‚              â”‚    â”‚ CLV =        â”‚ (NOW uses odds_at_kickoff!) â”‚
â”‚     â”‚ Uses         â”‚    â”‚ +23.5%       â”‚                            â”‚
â”‚     â”‚ odds_at_     â”‚    â”‚              â”‚                            â”‚
â”‚     â”‚ kickoff for   â”‚    â”‚              â”‚                            â”‚
â”‚     â”‚ CLV          â”‚    â”‚              â”‚                            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Benefits

1. **Accurate ROI Calculation** - ROI now uses actual odds when alert was sent
2. **Meaningful CLV** - CLV now compares alert odds vs kickoff odds
3. **Reliable Learning** - Optimizer adjusts weights based on correct performance data
4. **Backward Compatible** - Old fields kept for existing records
5. **Debuggable** - `alert_sent_at` timestamp helps track alert timing

## Monitoring

After deployment, monitor these metrics:

### Data Quality Metrics

```bash
python -m src.services.odds_capture
```

Key metrics:
- `kickoff_capture_rate`: Should be > 90%
- `with_alert_odds`: Should equal `total_sent` (100%)

### Learning Loop Metrics

Check optimizer logs for:
- ROI values that make sense (not all ~0%)
- CLV values that vary (not all ~0%)
- Driver weights adjusting based on real performance

### Log Messages

Look for these V8.3 debug messages:

```
ðŸ“Š V8.3: Captured odds at alert time: 2.10 for Home Win
ðŸ“Š V8.3: Using odds_at_alert for ROI: 2.10
âœ… Captured kickoff odds: 1.70 for Home Win (Team A vs Team B)
ðŸ“ˆ CLV: +23.50% (taken @2.10 vs closing @1.70)
```

## Troubleshooting

### Issue: Low kickoff capture rate

**Symptoms:**
- `kickoff_capture_rate` < 80%
- Many records without `odds_at_kickoff`

**Possible Causes:**
1. Scheduled job not running
2. Data provider not refreshing odds
3. Match status not updating correctly

**Solutions:**
1. Check cron/systemd timer is active
2. Check logs for errors in `odds_capture.py`
3. Verify data provider is working

### Issue: No odds_at_alert values

**Symptoms:**
- `with_alert_odds` < `total_sent`
- Many NULL values in `odds_at_alert` column

**Possible Causes:**
1. Migration not run
2. Code changes not deployed
3. Database write errors

**Solutions:**
1. Run migration: `python -m src.database.migration_v83_odds_fix`
2. Restart bot to load new code
3. Check logs for database errors

## Rollback

If issues arise, you can rollback by:

1. Stop the bot
2. Restore database from backup (made before migration)
3. Revert code changes:
   - `src/main.py` (remove odds_at_alert capture)
   - `src/analysis/settler.py` (revert to old ROI/CLV logic)
4. Delete new files:
   - `src/services/odds_capture.py`
   - `src/deploy_v83_odds_fix.py`

## Summary

This V8.3 fix ensures the bot's learning loop has **accurate historical odds data** for:

- **ROI Calculation** - Uses actual odds when alert was sent
- **CLV Analysis** - Compares alert odds vs kickoff odds
- **Strategy Optimization** - Adjusts weights based on real performance

The learning loop integrity is now **guaranteed** for all new alerts.
